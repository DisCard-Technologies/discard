# Story 1.2: User Registration & Privacy-First Authentication

## Status
Ready for Review

## Story

**As a** privacy-conscious user,
**I want** to create an account with minimal personal information while maintaining security,
**so that** I can access DisCard services without compromising my privacy.

## Acceptance Criteria

1. User registration requires only email address and secure password with optional privacy-focused username
2. Email verification process implemented with temporary verification codes that expire within 24 hours
3. Password security enforced with minimum complexity requirements and secure hashing using industry standards
4. User session management implemented with secure JWT tokens and automatic expiration
5. Account recovery process available through email verification without storing security questions or personal details
6. Privacy policy and terms of service clearly presented during registration with explicit consent for minimal data collection
7. Optional two-factor authentication available using TOTP applications without requiring phone numbers

## Tasks / Subtasks

- [x] Backend Authentication Service Implementation (AC: 1, 2, 3, 4, 5)
  - [x] Create auth controller at `/apps/api/src/services/auth/auth.controller.ts`
  - [x] Create auth service at `/apps/api/src/services/auth/auth.service.ts`
  - [x] Create auth routes at `/apps/api/src/services/auth/auth.routes.ts`
  - [x] Implement user registration endpoint `/auth/register`
  - [x] Implement email verification endpoint `/auth/verify-email`
  - [x] Implement login endpoint `/auth/login`
  - [x] Implement token refresh endpoint `/auth/refresh-token`
  - [x] Implement password reset endpoints `/auth/forgot-password` and `/auth/reset-password`

- [x] Database Integration (AC: 1, 2, 3, 4, 5)
  - [x] Implement user creation with encrypted email storage
  - [x] Create email verification token management
  - [x] Implement secure password hashing with bcrypt
  - [x] Add JWT token generation and validation
  - [x] Create user session management

- [x] Security Implementation (AC: 3, 4, 7)
  - [x] Implement password complexity validation (min 8 chars, mixed case, numbers, special chars)
  - [x] Configure JWT token expiration and refresh mechanism
  - [x] Add rate limiting for authentication endpoints
  - [x] Implement account lockout after failed attempts
  - [x] Add optional TOTP 2FA support

- [x] Privacy Policy Integration (AC: 6)
  - [x] Create privacy policy acceptance tracking
  - [x] Implement explicit consent mechanisms
  - [x] Add privacy settings initialization

- [x] API Route Integration (AC: 1, 2, 3, 4, 5, 7)
  - [x] Mount auth routes in main Express app
  - [x] Add authentication middleware for protected routes
  - [x] Implement JWT token validation middleware

- [x] Testing Implementation
  - [x] Create auth service unit tests
  - [x] Create auth controller unit tests
  - [x] Create auth API integration tests
  - [x] Add security and rate limiting tests

## Dev Notes

### Previous Story Insights
- **Supabase Configuration**: Database and auth infrastructure is already configured [Source: Story 1.1 completion notes]
- **Express.js API**: TypeScript-based Express API framework is ready with proper security headers [Source: Story 1.1 completion notes]
- **JWT Infrastructure**: JWT tokens mentioned in acceptance criteria and supported by existing setup [Source: Story 1.1 completion notes]
- **Row Level Security**: Database policies already implemented for multi-tenant security [Source: Story 1.1 completion notes]
- **TypeScript Shared Packages**: Type definitions available in packages/shared for API contracts [Source: Story 1.1 completion notes]

### Data Models
**User Model Structure** [Source: architecture/data-models.md#User Model]:
```typescript
interface User {
  id: string; // UUID v4
  email: string; // Encrypted at rest
  emailVerified: boolean;
  createdAt: Date;
  lastActive: Date;
  privacySettings: {
    dataRetention: number; // Days
    analyticsOptOut: boolean;
  };
}
```

**Database Schema Details** [Source: architecture/database-schema.md]:
- Users table uses encrypted email storage with hash for lookup
- Password hashing with secure bcrypt implementation
- Privacy settings stored as JSONB with default values
- Row Level Security enabled for data isolation
- Email verification tracking with boolean flag

### API Specifications
**Authentication Endpoints** [Source: architecture/api-specification.md]:

**POST /auth/login**:
- Request: `{ email: string, password: string }`
- Response: `{ accessToken: string, refreshToken: string, expiresIn: number }`
- Status Codes: 200 (success), 401 (auth failed), 429 (rate limit)

**Authentication Format** [Source: architecture/api-specification.md#securitySchemes]:
- Bearer JWT tokens in Authorization header
- JWT format with secure signing and expiration

### File Locations
**Authentication Service Structure** [Source: architecture/unified-project-structure.md#Backend Services]:
- Controller: `/apps/api/src/services/auth/auth.controller.ts`
- Service Logic: `/apps/api/src/services/auth/auth.service.ts`
- Route Definitions: `/apps/api/src/services/auth/auth.routes.ts`
- Middleware: `/apps/api/src/middleware/auth.middleware.ts`

**Shared Types Location** [Source: architecture/unified-project-structure.md#Shared Packages]:
- API Types: `/packages/shared/src/types/api.ts`
- User Types: `/packages/shared/src/types/user.ts`

### Testing Requirements
**Test Structure** [Source: architecture/testing-strategy.md#Backend Tests]:
- Unit Tests: `/apps/api/tests/unit/services/auth.service.test.ts`
- Integration Tests: `/apps/api/tests/integration/auth.integration.test.ts`
- Test Framework: Jest + Supertest for API testing
- Fixtures: `/apps/api/tests/fixtures/users.fixture.ts`

**Authentication Test Examples** [Source: architecture/testing-strategy.md#Backend API Test]:
- Test JWT token generation and validation
- Test password hashing and verification
- Test rate limiting and security controls
- Test authentication middleware behavior
- Test database isolation and privacy controls

### Technical Constraints
**Technology Stack** [Source: architecture/mvp-focused-tech-stack.md]:
- Backend Framework: Express.js 4.18.2 with TypeScript 5.3.3
- Database: Supabase (PostgreSQL) with built-in auth capabilities
- Authentication: Supabase Auth with JWT token management
- Session Storage: Redis via Railway for session caching
- Testing: Jest 29.7.0 + Supertest for comprehensive testing

**Security Requirements** [Source: architecture/coding-standards.md#Critical Fullstack Rules]:
- Type Safety: All API contracts must use shared TypeScript interfaces from packages/shared
- Privacy by Default: All database queries must use row-level security contexts
- Secure Data Handling: Sensitive data (emails, passwords) must be encrypted at rest and in transit
- No Sensitive Logging: Never log sensitive information in plaintext

**External API Integration** [Source: architecture/external-apis.md#Supabase Auth]:
- Supabase provides built-in authentication capabilities
- JWT token generation and validation through Supabase client
- Row Level Security policies for user data isolation
- Email verification through Supabase auth system

## Testing

**Test File Locations** [Source: architecture/testing-strategy.md#Test Organization]:
- Unit Tests: `apps/api/tests/unit/services/auth.service.test.ts`
- Integration Tests: `apps/api/tests/integration/auth.integration.test.ts`
- Fixtures: `apps/api/tests/fixtures/users.fixture.ts`

**Testing Standards** [Source: architecture/testing-strategy.md#Backend API Test]:
- Use Jest + Supertest for API endpoint testing
- Include authentication flow testing with JWT validation
- Test security controls including rate limiting and account lockout
- Test privacy controls and data isolation
- Mock external Supabase auth calls for unit tests
- Use test fixtures for consistent user data

**Required Test Coverage**:
- User registration with email validation
- Email verification process and token expiration
- Login authentication with proper JWT generation
- Password hashing and verification security
- Rate limiting and brute force protection
- Authentication middleware functionality
- Privacy settings initialization and management

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-01 | 1.0 | Initial story creation with comprehensive technical context | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4 (James - Full Stack Developer Agent)

### Debug Log References
- Fixed JWT secrets configuration issue in test environment
- Resolved app export compatibility with supertest
- Implemented comprehensive rate limiting for authentication endpoints
- Added TOTP 2FA support with backup codes for enhanced security

### Completion Notes List
- **Authentication Service**: Complete auth service implementation with registration, login, email verification, password reset, and token management
- **Security Features**: Password complexity validation, account lockout, rate limiting, and optional TOTP 2FA with backup codes
- **Privacy-First Design**: Minimal data collection, optional usernames, privacy settings with data retention controls
- **Database Integration**: Updated schema with auth enhancements, verification tokens, TOTP secrets, and privacy policy tracking
- **Testing**: Comprehensive unit and integration tests covering all authentication flows and security features
- **API Integration**: Mounted auth routes with proper middleware and error handling

### File List
**New Files Created:**
- `apps/api/src/services/auth/auth.service.ts` - Core authentication service logic
- `apps/api/src/services/auth/auth.controller.ts` - HTTP request/response handling for auth endpoints
- `apps/api/src/services/auth/auth.routes.ts` - Route definitions with rate limiting
- `apps/api/src/services/auth/totp.service.ts` - TOTP 2FA functionality with backup codes
- `apps/api/src/services/privacy/privacy.service.ts` - Privacy policy and consent management
- `apps/api/src/__tests__/auth.service.test.ts` - Unit tests for auth service
- `apps/api/src/__tests__/auth.integration.test.ts` - Integration tests for auth API
- `database/migrations/002_auth_service_enhancements.sql` - Auth schema updates
- `database/migrations/003_totp_2fa_support.sql` - TOTP 2FA database schema
- `database/migrations/004_privacy_policy_tracking.sql` - Privacy policy tracking schema

**Modified Files:**
- `apps/api/src/app.ts` - Added auth routes integration and module.exports
- `apps/api/src/middleware/auth.ts` - Updated for new user structure and email verification
- `apps/api/env.example` - Added JWT_REFRESH_SECRET environment variable
- `packages/shared/src/types/index.ts` - Updated auth types and User interface
- `apps/api/package.json` - Added dependencies: express-rate-limit, speakeasy, qrcode, supertest

## QA Results

*Results from QA Agent review of the completed story implementation*