# Story 3.1: Marqeta Card Provisioning & Visa Network Integration

## Status
Ready

## Story

**As a** user,
**I want** my disposable cards to work at any merchant accepting Visa through Marqeta's card processing platform,
**so that** I can use them for both online and in-person purchases without merchant limitations while leveraging proven card infrastructure.

## Acceptance Criteria

1. Marqeta card provisioning system generates valid Visa network card numbers, CVV codes, and expiration dates for each disposable card
2. Card activation process enables immediate use upon creation with real-time Marqeta API registration and funding
3. Merchant acceptance validation ensures cards work for online purchases, in-store transactions, and ATM withdrawals through Marqeta's Visa connectivity
4. Card network communication handles authorization requests with sub-second response times leveraging Marqeta's proven infrastructure
5. Geographic spending controls allow users to restrict card usage to specific countries or regions using Marqeta's control features
6. Merchant category blocking enables users to prevent card usage at specific merchant types using Marqeta's MCC filtering capabilities
7. Card network status monitoring provides real-time feedback on Marqeta API connectivity and transaction processing capability

## Tasks / Subtasks

- [ ] **Marqeta Card Provisioning Engine** (AC: 1, 2)
  - [ ] Integrate Marqeta Core API for card provisioning and lifecycle management
  - [ ] Implement Marqeta card creation using POST /cards endpoint with spending controls
  - [ ] Configure Marqeta card product and BIN allocation for DisCard virtual cards
  - [ ] Create card number, CVV, and expiration date retrieval from Marqeta API responses
  - [ ] Add card activation workflow using PUT /cards/{token} endpoint for status updates
  - [ ] Implement card funding through Marqeta Gateway Payment Source (GPA) operations
  - [ ] Implement card status synchronization between DisCard and Marqeta platform
  - [ ] Add comprehensive error handling for provisioning failures and Marqeta API timeouts

- [ ] **Backend Marqeta Integration Service** (AC: 1, 2, 4, 7)
  - [ ] Create Marqeta integration service at `/apps/api/src/services/marqeta/marqeta.service.ts`
  - [ ] Create card provisioning controller at `/apps/api/src/services/marqeta/provisioning.controller.ts`
  - [ ] Implement POST `/api/v1/marqeta/cards/provision` endpoint for new card creation
  - [ ] Implement POST `/api/v1/marqeta/cards/{cardId}/activate` endpoint for card activation
  - [ ] Implement GET `/api/v1/marqeta/cards/{cardId}/status` endpoint for real-time status checking
  - [ ] Integrate Marqeta authentication with Application Token and Access Token
  - [ ] Add secure card data handling using Marqeta's tokenization system
  - [ ] Implement rate limiting for provisioning operations (1000 requests per minute limit)
  - [ ] Add comprehensive audit logging for all Marqeta API interactions
  - [ ] Create Marqeta API health monitoring and status reporting system

- [ ] **Database Schema Extensions** (AC: 1, 2, 7)
  - [ ] Extend cards table with Marqeta-specific fields (marqeta_token, card_product_token, pan_hash)
  - [ ] Create marqeta_transactions table for authorization request tracking and webhook data
  - [ ] Create card_network_status table for real-time Marqeta API connectivity monitoring
  - [ ] Add database migration 008_marqeta_integration_schema.sql following established sequence
  - [ ] Implement row-level security policies for Marqeta card data isolation using existing context_hash pattern
  - [ ] Create indexes for optimal card lookup performance during authorization using marqeta_token
  - [ ] Add encrypted storage for sensitive Marqeta API credentials and card tokens

- [ ] **Geographic and Merchant Controls** (AC: 5, 6)
  - [ ] Implement geographic restriction service with country/region blocking
  - [ ] Create merchant category code (MCC) filtering system
  - [ ] Add card controls table for user-defined spending restrictions
  - [ ] Implement POST `/api/v1/cards/{cardId}/controls/geographic` endpoint for location restrictions
  - [ ] Implement POST `/api/v1/cards/{cardId}/controls/merchant` endpoint for MCC blocking
  - [ ] Create real-time control validation during transaction authorization
  - [ ] Add user interface for managing card controls and restrictions
  - [ ] Implement control inheritance for card creation with default restrictions

- [ ] **Card Network Communication Layer** (AC: 3, 4, 7)
  - [ ] Implement Visa Direct API client with proper authentication and security
  - [ ] Create authorization request handling with sub-second response requirements
  - [ ] Implement network failover and retry logic for high availability
  - [ ] Add comprehensive network monitoring and alerting system
  - [ ] Create merchant validation service for acceptance verification
  - [ ] Implement ATM network integration for cash withdrawal support
  - [ ] Add network performance metrics and SLA monitoring
  - [ ] Create network status dashboard for real-time connectivity monitoring

- [ ] **Frontend Card Management Interface** (AC: 5, 6, 7)
  - [ ] Create CardProvisioningComponent at `/apps/mobile/src/components/cards/CardProvisioningComponent.tsx`
  - [ ] Create CardControlsScreen at `/apps/mobile/src/screens/cards/CardControlsScreen.tsx`
  - [ ] Create NetworkStatusIndicator at `/apps/mobile/src/components/cards/NetworkStatusIndicator.tsx`
  - [ ] Implement geographic controls interface with country/region selection
  - [ ] Add merchant category blocking interface with common restrictions preset
  - [ ] Create card network status display with real-time connectivity indicators
  - [ ] Implement card provisioning progress tracking and status updates
  - [ ] Add error handling and user feedback for provisioning failures

- [ ] **State Management for Visa Integration** (AC: 2, 7)
  - [ ] Extend cards store at `/apps/mobile/src/stores/cards.tsx` with Visa-specific state
  - [ ] Implement card provisioning state management and progress tracking
  - [ ] Add network status monitoring state with real-time updates
  - [ ] Create card controls state management for restrictions and limits
  - [ ] Implement provisioning error handling and retry mechanisms
  - [ ] Add card activation state tracking and user notifications

- [ ] **Testing Implementation** (Testing Strategy Requirements)
  - [ ] Backend unit tests at `/apps/api/src/__tests__/unit/services/visa/visa.service.test.ts`
  - [ ] Backend unit tests at `/apps/api/src/__tests__/unit/services/visa/provisioning.controller.test.ts`
  - [ ] Integration tests at `/apps/api/src/__tests__/integration/visa-provisioning.integration.test.ts`
  - [ ] Frontend component tests at `/apps/mobile/__tests__/components/cards/CardProvisioningComponent.test.tsx`
  - [ ] Frontend component tests at `/apps/mobile/__tests__/components/cards/NetworkStatusIndicator.test.tsx`
  - [ ] E2E tests at `/apps/mobile/__tests__/e2e/visa-card-provisioning-workflows.e2e.test.ts`
  - [ ] Mock implementations for Visa Direct API with realistic response scenarios
  - [ ] Security tests for PCI DSS compliance and card data protection
  - [ ] Performance tests for provisioning speed and network response times
  - [ ] Load tests for concurrent card provisioning scenarios

## Dev Notes

### Background Context
Stories 2.1 and 2.2 successfully implemented comprehensive cryptocurrency wallet integration and fintech-grade testing infrastructure. The crypto funding system provides users with the ability to fund their cards using Bitcoin, Ethereum, and other cryptocurrencies. Now users need actual Visa cards that work at merchants to complete the payment ecosystem.

### Integration Strategy
This story represents the critical bridge between the cryptocurrency funding system and real-world payment acceptance. The Visa network integration will enable users to spend their cryptocurrency-funded balances at any merchant accepting Visa cards, completing the crypto-to-fiat payment flow.

### Data Models
**Extended Card Model** [Source: architecture/data-models.md#card-model]:
```typescript
interface Card {
  // Existing fields from Story 1.3
  cardId: string;
  cardNumber: string; // Now actual Visa card number
  cvv: string; // Now actual CVV from Visa
  expirationDate: string; // MM/YY format
  currentBalance: number;
  spendingLimit: number;
  status: 'active' | 'paused' | 'expired' | 'deleted';
  
  // New Visa-specific fields
  binRange: string; // Bank Identification Number
  visaCardId: string; // Visa's internal card identifier
  networkToken: string; // Visa Token Service token
  activationStatus: 'pending' | 'activated' | 'failed';
  networkStatus: 'connected' | 'degraded' | 'offline';
  lastNetworkCheck: Date;
}
```

**Card Controls Model** [New]:
```typescript
interface CardControls {
  controlId: string;
  cardId: string;
  geographicRestrictions: {
    allowedCountries: string[]; // ISO country codes
    blockedCountries: string[];
    allowedRegions: string[];
  };
  merchantRestrictions: {
    blockedMccCodes: string[]; // Merchant Category Codes
    allowedMccCodes: string[];
    customMerchantBlocks: string[];
  };
  spendingControls: {
    dailyLimit: number;
    monthlyLimit: number;
    perTransactionLimit: number;
  };
  timeRestrictions: {
    allowedHours: { start: string; end: string; };
    allowedDays: string[]; // Days of week
    timezone: string;
  };
}
```

### API Specifications
**Visa Integration Endpoints** [Source: architecture/api-specification.md#visa-endpoints]:
- `POST /api/v1/visa/cards/provision` - Provision new Visa card with BIN allocation
- `POST /api/v1/visa/cards/{cardId}/activate` - Activate card on Visa network
- `GET /api/v1/visa/cards/{cardId}/status` - Real-time network status and connectivity
- `POST /api/v1/cards/{cardId}/controls/geographic` - Set geographic spending controls
- `POST /api/v1/cards/{cardId}/controls/merchant` - Configure merchant restrictions
- `GET /api/v1/visa/network/status` - Overall network health and connectivity

### Component Specifications
**Visa Network Integration Service** [Source: architecture/components.md#visa-integration-service]:
- Real-time card provisioning and activation through Visa Direct API
- PCI DSS compliant card data handling and storage
- Geographic and merchant controls enforcement
- Network health monitoring and failover capabilities
- Technology Stack: Node.js with Visa Direct SDK, Redis for session management, encrypted database storage

### Security Requirements
**PCI DSS Compliance** [Source: architecture/coding-standards.md#critical-security-rules]:
- Card data encryption at rest using AES-256 encryption
- Secure transmission using TLS 1.3 for all Visa API communications
- Card number tokenization through Visa Token Service
- Audit logging for all card provisioning and modification activities
- Access controls limiting card data access to authorized personnel only

**Privacy by Default** [Source: architecture/coding-standards.md#privacy-requirements]:
- Card provisioning must use isolation contexts to prevent cross-card correlation
- Minimal data collection for Visa compliance while maintaining user privacy
- Encrypted storage for all sensitive card data with KMS key management
- Automatic data purging when cards are deleted or expired

### External API Integration
**Visa Direct Integration** [Source: architecture/external-apis.md#visa-direct-integration]:
- Visa Direct provides comprehensive card provisioning and lifecycle management
- Real-time authorization processing with sub-second response times
- Merchant acceptance validation across global Visa network
- Geographic and merchant controls enforcement at the network level
- Rate limits: 1000 provisioning requests per hour, unlimited authorization requests

### Testing Requirements
**Security Testing** [Source: architecture/testing-strategy.md#security-testing]:
- PCI DSS compliance validation tests
- Card data encryption and tokenization security tests
- Authorization request security and privacy tests
- Network security tests for Visa API communications
- Penetration testing for card provisioning endpoints

**Performance Testing** [Source: architecture/testing-strategy.md#performance-testing]:
- Card provisioning speed tests (target: <5 seconds)
- Authorization response time tests (target: <1 second)
- Concurrent provisioning load tests (target: 100 simultaneous provisions)
- Network failover and recovery testing
- Geographic controls validation performance tests

### Technical Constraints
**Visa Network Requirements**:
- BIN range allocation requires Visa certification and partnership
- PCI DSS Level 1 compliance mandatory for card data handling
- Real-time authorization processing requires dedicated network connections
- Geographic controls must integrate with Visa's fraud prevention systems
- Merchant category controls require MCC code validation and updates

**Regulatory Compliance**:
- Card issuer licensing required for Visa card provisioning
- Anti-money laundering (AML) compliance for large transactions
- Know Your Customer (KYC) requirements for card provisioning
- Regional financial regulations (EU PSD2, US Bank Secrecy Act)
- Data protection compliance (GDPR, CCPA) for card data handling

### Dependencies and Prerequisites
- **Visa Partnership**: Active Visa Direct partnership and API access
- **BIN Range Allocation**: Assigned Bank Identification Numbers for DisCard
- **PCI DSS Certification**: Level 1 compliance certification complete
- **Card Issuer License**: Financial services licensing for card issuance
- **KYC/AML Systems**: Customer verification and compliance systems
- **Secure Infrastructure**: PCI DSS compliant hosting and database encryption
- **Testing Environment**: Visa sandbox environment for development and testing

### Success Metrics
- **Card Provisioning Success Rate**: 99%+ successful provisioning within 5 seconds
- **Network Authorization Response**: <1 second average response time
- **Merchant Acceptance**: 99%+ acceptance rate at Visa-accepting merchants
- **Network Uptime**: 99.9% availability for authorization processing
- **Geographic Controls**: <100ms validation time for location-based restrictions
- **Merchant Controls**: <50ms validation time for MCC-based restrictions
- **Security Compliance**: 100% PCI DSS audit compliance
- **User Experience**: <3 steps to provision and activate new card

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-08 | 1.0 | Initial story creation based on Epic 3.1 requirements | Claude (Story Generator) |

## Dev Agent Record

*This section will be populated by the development agent during implementation*

### Agent Model Used
[To be filled during implementation]

### Current Implementation Phase
[To be filled during implementation]

### Debug Log References
[To be filled during implementation]

### Completion Notes List
[To be filled during implementation]

### File List
[To be filled during implementation]

## QA Results

*This section will be populated during QA review*

### Review Date
[To be filled during QA review]

### Reviewed By
[To be filled during QA review]

### Story Assessment
[To be filled during QA review]