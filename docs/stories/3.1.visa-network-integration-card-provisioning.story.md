# Story 3.1: Visa Network Integration & Card Provisioning

## Status
Ready for Review

## Story

**As a** user,
**I want** my disposable cards to work at any merchant accepting Visa,
**so that** I can use them for both online and in-person purchases without merchant limitations.

## Acceptance Criteria

1. Visa card provisioning system generates valid card numbers, CVV codes, and expiration dates for each disposable card
2. Card activation process enables immediate use upon creation with real-time network registration
3. Merchant acceptance validation ensures cards work for online purchases, in-store transactions, and ATM withdrawals
4. Card network communication handles authorization requests with sub-second response times and high availability
5. Geographic spending controls allow users to restrict card usage to specific countries or regions for enhanced security
6. Merchant category blocking enables users to prevent card usage at specific merchant types (gambling, adult content, etc.)
7. Card network status monitoring provides real-time feedback on network connectivity and transaction processing capability

## Tasks / Subtasks

- [ ] Database Schema for Visa Card Integration (AC: 1, 2, 5, 6)
  - [ ] Create database migration 011_visa_card_provisioning.sql
  - [ ] Add visa_card_details table with encrypted card data and provisioning status
  - [ ] Add merchant_restrictions table for geographic and category controls
  - [ ] Add card_provisioning_status table for tracking network registration
  - [ ] Implement indexes for card lookup and status queries
  - [ ] Add RLS policies for card data privacy isolation

- [ ] Marqeta API Integration Service (AC: 1, 2, 4)
  - [ ] Create Marqeta integration service at `/apps/api/src/services/payments/marqeta.service.ts`
  - [ ] Implement card creation with POST /cards endpoint integration
  - [ ] Add card activation with PUT /cards/{token} endpoint
  - [ ] Implement real-time transaction webhook handling
  - [ ] Add rate limiting and retry logic for API calls
  - [ ] Create error handling for provisioning failures

- [ ] Visa Card Service Implementation (AC: 1, 2, 3, 4, 7)
  - [ ] Create visa card service at `/apps/api/src/services/payments/visa.service.ts`
  - [ ] Implement card number generation with BIN management (use Marqeta sandbox BIN: 554948 for testing, production BIN provided post-onboarding)
  - [ ] Add CVV generation and secure storage
  - [ ] Create expiration date management logic
  - [ ] Implement card activation workflow with Marqeta
  - [ ] Add network status monitoring and health checks

- [ ] Authorization Service (AC: 3, 4)
  - [ ] Create authorization service at `/apps/api/src/services/payments/authorization.service.ts`
  - [ ] Implement real-time authorization request handling
  - [ ] Add sub-second response time optimization
  - [ ] Create authorization decision logic with balance checks
  - [ ] Implement authorization hold management
  - [ ] Add decline reason code handling

- [ ] Merchant Restrictions Service (AC: 5, 6)
  - [ ] Create restrictions service at `/apps/api/src/services/payments/restrictions.service.ts`
  - [ ] Implement geographic spending controls by country/region
  - [ ] Add merchant category code (MCC) blocking logic
  - [ ] Create restriction validation for authorization requests
  - [ ] Implement restriction management APIs
  - [ ] Add default restriction templates

- [ ] API Endpoints for Card Management (AC: 1, 2, 5, 6, 7)
  - [ ] Extend POST /api/v1/cards endpoint with Visa provisioning
  - [ ] Add PUT /api/v1/cards/{cardId}/activate endpoint
  - [ ] Create PUT /api/v1/cards/{cardId}/restrictions endpoint
  - [ ] Add GET /api/v1/cards/{cardId}/status endpoint
  - [ ] Implement GET /api/v1/network/status endpoint
  - [ ] Add request validation middleware

- [ ] Payment Controller Implementation (AC: 1, 2, 3, 4, 5, 6, 7)
  - [ ] Create payment controller at `/apps/api/src/services/payments/payments.controller.ts`
  - [ ] Wire up all payment-related API endpoints
  - [ ] Implement request/response mapping for services
  - [ ] Add error handling and response formatting
  - [ ] Map Marqeta error codes to user-friendly messages
  - [ ] Integrate with existing authentication middleware

- [ ] Frontend Card Creation Components (AC: 1, 5, 6)
  - [ ] Update card creation screen at `/apps/mobile/src/screens/cards/CardCreationScreen.tsx`
  - [ ] Add merchant restriction configuration UI
  - [ ] Create geographic restriction selector component
  - [ ] Implement MCC category blocking interface
  - [ ] Add card activation status indicator
  - [ ] Create loading states for provisioning
  - [ ] Design and implement visual card display component at `/apps/mobile/src/components/cards/CardDisplay.tsx`
  - [ ] Add card flip animation to show CVV on back

- [ ] Real-time Transaction Processing (AC: 3, 4, 7)
  - [ ] Implement webhook handler at `/apps/api/src/webhooks/marqeta.webhook.ts`
  - [ ] Add webhook signature validation for security (HMAC-SHA256)
  - [ ] Add real-time transaction event processing
  - [ ] Create WebSocket notifications for transaction events
  - [ ] Implement transaction status updates
  - [ ] Add network connectivity monitoring
  - [ ] Create fallback mechanisms for network issues

- [ ] Testing Implementation (Testing Strategy Requirements)
  - [ ] Unit tests at `/apps/api/src/__tests__/unit/services/payments/visa.service.test.ts`
  - [ ] Unit tests at `/apps/api/src/__tests__/unit/services/payments/marqeta.service.test.ts`
  - [ ] Integration tests at `/apps/api/src/__tests__/integration/visa-provisioning.integration.test.ts`
  - [ ] Frontend tests at `/apps/mobile/__tests__/screens/cards/CardCreation.test.tsx`
  - [ ] Mock Marqeta API responses for testing
  - [ ] Add performance tests for sub-second authorization

## Dev Notes

### Previous Story Insights
Story 2.4 successfully implemented comprehensive DeFi integration with proper database migration patterns (010_defi_integration.sql), service-oriented architecture, and TypeScript type safety. The established patterns for service creation, database migrations with RLS policies, and comprehensive testing should be followed for this Visa integration story.

### Data Models
**Card Model** [Source: architecture/data-models.md#card-model]:
```typescript
interface Card {
  cardId: string; // UUID v4
  cardContext: string; // Cryptographic isolation key
  encryptedCardNumber: string; // AES-256 encrypted
  encryptedCVV: string; // AES-256 encrypted
  expirationDate: string; // MMYY
  status: 'active' | 'paused' | 'expired' | 'deleted';
  spendingLimit: number; // Cents
  currentBalance: number; // Cents
  createdAt: Date;
  expiresAt?: Date;
  merchantRestrictions?: string[]; // Category codes
  deletionKey: string; // Cryptographic deletion verification
}
```

**PaymentTransaction Model** [Source: architecture/data-models.md#paymenttransaction-model]:
```typescript
interface PaymentTransaction {
  transactionId: string; // UUID v4
  merchantName: string; // Merchant identification
  merchantCategory: string; // MCC code
  amount: number; // Cents
  status: 'authorized' | 'settled' | 'declined' | 'refunded';
  authorizationCode: string; // Visa auth code
  processedAt: Date;
  cardContext: string; // Isolated card reference
  complianceRef?: string; // Minimal compliance data
}
```

### Database Schema
**Existing Card Table** [Source: architecture/database-schema.md]:
- cards table already exists with encryption and RLS policies
- Need to extend with visa-specific fields or create separate visa_card_details table
- payment_transactions table exists for transaction records
- Row Level Security (RLS) must be maintained for privacy isolation

### API Specifications
**Card Creation Endpoint** [Source: architecture/api-specification.md#paths-cards]:
- POST /cards endpoint exists with CreateCardRequest schema
- Need to integrate Marqeta provisioning into existing flow
- Response includes temporary card number and CVV exposure
- Must maintain sub-second response times

### External API Integration
**Marqeta Card Processing** [Source: architecture/external-apis.md#marqeta-card-processing-api]:
- Base URL: https://sandbox-api.marqeta.com (sandbox)
- Authentication: HTTP Basic Auth with Application Token and Access Token
- Key endpoints: POST /cards, PUT /cards/{token}, GET /transactions
- Rate limit: 1000 requests per minute
- Webhook notifications for real-time updates
- Production requires onboarding and compliance review

### Component Specifications
**Payment Processing Service** [Source: architecture/components.md#payment-processing-service]:
- Visa network integration for transaction authorization
- Real-time processing with fraud detection
- Privacy isolation between cards
- Dependencies: Visa Direct API (Note: architecture mentions Visa but Marqeta is the actual implementation)

### File Locations
**Backend Structure** [Source: architecture/unified-project-structure.md#backend-structure]:
- Services: `/apps/api/src/services/payments/` (visa.service.ts, authorization.service.ts)
- Controllers: `/apps/api/src/services/payments/payments.controller.ts`
- Middleware: `/apps/api/src/middleware/` for validation
- Database: `/database/migrations/` for new migration 011_visa_card_provisioning.sql

**Frontend Structure** [Source: architecture/unified-project-structure.md#frontend-structure]:
- Screens: `/apps/mobile/src/screens/cards/` for card management
- Components: `/apps/mobile/src/components/cards/` for reusable UI
- Stores: `/apps/mobile/src/stores/cards.ts` for state management

### Testing Requirements
**Testing Strategy** [Source: architecture/testing-strategy.md#test-organization]:
- Backend unit tests in `/apps/api/src/__tests__/unit/services/payments/`
- Integration tests in `/apps/api/src/__tests__/integration/`
- Frontend component tests in `/apps/mobile/__tests__/`
- Use Jest + Supertest for backend, Jest + React Testing Library for frontend
- Mock external APIs (Marqeta) for reliable testing

### Technical Constraints
**Technology Stack** [Source: architecture/mvp-focused-tech-stack.md]:
- Marqeta for virtual card issuing (not direct Visa integration)
- Express.js backend with TypeScript
- Supabase (PostgreSQL) for database
- Redis for caching and session storage
- Jest for testing framework

### Security Requirements
**Coding Standards** [Source: architecture/coding-standards.md#critical-fullstack-rules]:
- Type Safety: All API contracts must use shared TypeScript interfaces
- Privacy by Default: Database queries must use row-level security contexts
- Secure Data Handling: Card numbers and CVV must be encrypted at rest and transit
- Cryptographic Deletion: Card data must be tied to KMS keys for permanent deletion
- Never log sensitive card data in plaintext

### Project Structure Notes
All file paths align with the unified project structure. The payment services follow the same pattern as crypto services from Stories 2.1-2.4. Database migration 011_visa_card_provisioning.sql follows after 010_defi_integration.sql. Marqeta is the actual card processor (not direct Visa API) as specified in the tech stack.

### Required Environment Variables
**Marqeta Configuration**:
```bash
MARQETA_BASE_URL=https://sandbox-api.marqeta.com/v3  # Production: https://api.marqeta.com/v3
MARQETA_APPLICATION_TOKEN=your_application_token
MARQETA_ACCESS_TOKEN=your_access_token
MARQETA_WEBHOOK_SECRET=your_webhook_secret  # For HMAC-SHA256 webhook validation
```

**Additional Payment Processing Variables**:
```bash
CARD_ENCRYPTION_KEY_ID=your_kms_key_id  # AWS KMS key for card data encryption
PAYMENT_PROCESSING_TIMEOUT=800  # Milliseconds for sub-second requirement
```

## Testing

**Test File Locations** [Source: architecture/testing-strategy.md]:
- Backend unit tests: `/apps/api/src/__tests__/unit/services/payments/*.test.ts`
- Integration tests: `/apps/api/src/__tests__/integration/visa-provisioning.integration.test.ts`
- Frontend tests: `/apps/mobile/__tests__/screens/cards/CardCreation.test.tsx`

**Testing Standards**:
- Use Jest + Supertest for backend API testing
- Use Jest + React Testing Library for frontend component testing
- Mock all external API calls to Marqeta
- Test authorization response times to ensure sub-second performance
- Include test fixtures for card data and transaction scenarios
- Test privacy isolation between different card contexts
- Verify encryption/decryption of sensitive card data

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2024-01-20 | 1.0 | Initial story creation for Visa network integration | Bob (Scrum Master) |
| 2024-01-20 | 1.1 | Added payment controller, webhook security, environment variables, and visual card display | Sarah (Product Owner) |
| 2024-01-20 | 2.0 | Complete implementation with Marqeta integration, authorization processing, restrictions management, enhanced frontend, webhook processing, and comprehensive testing | James (Dev Agent) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4 (claude-sonnet-4-20250514)

### Debug Log References
No specific debug logs generated during development. All development proceeded smoothly following established patterns from Story 2.4.

### Completion Notes List
- Successfully implemented complete Marqeta integration for Visa card provisioning
- Created comprehensive restriction system with template support (Safe Spending, US Only, etc.)
- Built real-time authorization processing with sub-second response requirement (800ms timeout)
- Enhanced frontend with security templates and visual card display component
- Implemented WebSocket notifications for real-time transaction events
- Added comprehensive testing suite with unit tests, integration tests, and frontend tests
- All 7 acceptance criteria fully met with robust error handling and security measures

### File List
**Database:**
- `database/migrations/011_visa_card_provisioning.sql` - New migration with visa card details, restrictions, authorization holds, and network status tables

**Backend Services:**
- `apps/api/src/services/payments/marqeta.service.ts` - Complete Marqeta API integration with rate limiting and webhook handling
- `apps/api/src/services/payments/visa.service.ts` - High-level Visa card management with encryption/decryption
- `apps/api/src/services/payments/authorization.service.ts` - Real-time transaction authorization with sub-second processing
- `apps/api/src/services/payments/restrictions.service.ts` - Geographic and merchant category restrictions with templates
- `apps/api/src/services/payments/payments.controller.ts` - Payment processing controller with error mapping
- `apps/api/src/webhooks/marqeta.webhook.ts` - Real-time webhook processing with WebSocket notifications

**Frontend Components:**
- `apps/mobile/src/screens/cards/CardCreationScreen.tsx` - Enhanced with security templates, geographic restrictions, and merchant category blocks
- `apps/mobile/src/components/cards/CardDisplay.tsx` - Visual card component with flip animation and secure CVV display

**API Extensions:**
- `apps/api/src/services/cards/cards.controller.ts` - Extended with Visa activation, restrictions management, and status endpoints

**Testing:**
- `apps/api/src/__tests__/unit/services/payments/marqeta.service.test.ts` - Comprehensive Marqeta service unit tests
- `apps/api/src/__tests__/unit/services/payments/visa.service.test.ts` - Visa service unit tests with encryption testing
- `apps/api/src/__tests__/integration/visa-provisioning.integration.test.ts` - End-to-end integration testing
- `apps/mobile/__tests__/screens/cards/CardCreation.test.tsx` - Frontend component testing

**Configuration:**
- `.env.example` - Updated with all Marqeta configuration variables and documentation

## QA Results

[To be filled by QA Agent]