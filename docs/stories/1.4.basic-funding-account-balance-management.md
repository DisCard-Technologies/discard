# Story 1.4: Basic Funding & Account Balance Management

## Status
Draft

## Story

**As a** user,
**I want** to add funds to my DisCard account and allocate them to specific cards,
**so that** I can make purchases with my disposable cards.

## Acceptance Criteria

1. Account funding interface supports traditional payment methods including bank transfers and debit cards for initial funding
2. Fund allocation system allows users to transfer account balance to specific disposable cards with real-time balance updates
3. Balance management interface shows total account balance, allocated funds, and available balance with clear visual presentation
4. Fund transfer between cards enabled with instant processing and balance confirmation
5. Low balance notifications implemented for both account and individual cards with customizable threshold settings
6. Transaction pending and confirmation states clearly displayed during funding operations with estimated processing times
7. Basic fraud protection implemented for funding operations including spending limits and unusual activity detection

## Tasks / Subtasks

- [ ] Backend Funding Service Implementation (AC: 1, 2, 4, 7)
  - [ ] Create funding controller at `/apps/api/src/services/funding/funding.controller.ts`
  - [ ] Create funding service at `/apps/api/src/services/funding/funding.service.ts`
  - [ ] Create Stripe service at `/apps/api/src/services/funding/stripe.service.ts`
  - [ ] Create account balance service at `/apps/api/src/services/funding/balance.service.ts`
  - [ ] Implement POST `/api/v1/funding/account` endpoint for account funding via Stripe
  - [ ] Implement POST `/api/v1/funding/card/{cardId}` endpoint for card allocation
  - [ ] Implement POST `/api/v1/funding/transfer` endpoint for card-to-card transfers
  - [ ] Implement GET `/api/v1/funding/balance` endpoint for balance inquiries
  - [ ] Implement POST `/api/v1/funding/webhooks/stripe` endpoint for Stripe webhook processing
  - [ ] Implement fraud protection with Stripe Radar integration and rate limiting

- [ ] Database Schema Extensions for Funding (AC: 1, 2, 3, 4)
  - [ ] Create account_balances table with cryptographic isolation
  - [ ] Create funding_transactions table for transaction tracking
  - [ ] Create fund_allocations table for card funding records
  - [ ] Implement row-level security policies for funding isolation
  - [ ] Add database migrations for funding schema
  - [ ] Create indexes for optimal funding query performance

- [ ] Payment Method Integration (AC: 1, 6, 7)
  - [ ] Integrate Stripe payment processor for traditional payment methods
  - [ ] Implement Stripe Elements for secure bank transfer and debit card collection
  - [ ] Add Stripe webhook handling for payment status updates (pending, succeeded, failed)
  - [ ] Implement Stripe payment method validation and verification
  - [ ] Add estimated processing time calculations based on Stripe payment method types
  - [ ] Integrate Stripe Radar for fraud detection and spending limits
  - [ ] Create Stripe customer management for recurring payment methods

- [ ] Frontend Mobile Funding Interface (AC: 1, 2, 3, 5, 6)
  - [ ] Create FundingScreen at `/apps/mobile/src/screens/funding/FundingScreen.tsx`
  - [ ] Create BalanceManagementScreen at `/apps/mobile/src/screens/funding/BalanceManagementScreen.tsx`
  - [ ] Create CardAllocationScreen at `/apps/mobile/src/screens/funding/CardAllocationScreen.tsx`
  - [ ] Implement FundingComponent at `/apps/mobile/src/components/funding/FundingComponent.tsx`
  - [ ] Create BalanceIndicator at `/apps/mobile/src/components/funding/BalanceIndicator.tsx`
  - [ ] Add funding state management in `/apps/mobile/src/stores/funding.ts`
  - [ ] Implement low balance notifications with customizable thresholds

- [ ] Frontend Web Funding Interface (AC: 1, 2, 3, 5, 6)
  - [ ] Create funding pages at `/apps/web/src/app/dashboard/funding/`
  - [ ] Implement FundingForm at `/apps/web/src/components/funding/FundingForm.tsx`
  - [ ] Create BalanceDisplay at `/apps/web/src/components/funding/BalanceDisplay.tsx`
  - [ ] Create AllocationManager at `/apps/web/src/components/funding/AllocationManager.tsx`
  - [ ] Add real-time balance updates with React Query
  - [ ] Implement notification system for low balance alerts

- [ ] Shared Types and Utilities (AC: 1, 2, 3, 4)
  - [ ] Create funding types in `/packages/shared/src/types/funding.ts`
  - [ ] Add Stripe payment types in `/packages/shared/src/types/stripe.ts`
  - [ ] Add balance calculation utilities in `/packages/shared/src/utils/funding.ts`
  - [ ] Implement funding validation helpers in `/packages/shared/src/utils/validation.ts`
  - [ ] Create funding constants in `/packages/shared/src/constants/funding.ts`
  - [ ] Create Stripe constants in `/packages/shared/src/constants/stripe.ts`

## Dev Notes

### Previous Story Insights
- **Security Model**: From Story 1.3, maintain AES-256-CBC encryption for sensitive data and cryptographic isolation through context hashing [Source: docs/stories/1.3.core-card-creation-management-interface.md#security-review]
- **Rate Limiting**: Continue pattern of 10 creations/hour, 100 ops/15min for new funding endpoints [Source: docs/stories/1.3.core-card-creation-management-interface.md#security-review]
- **Domain Separation**: Maintain clean boundaries between funding, cards, and authentication services [Source: docs/stories/1.3.core-card-creation-management-interface.md#architecture-review]
- **Optimization Opportunity**: Consider Redis caching for frequently accessed balance data [Source: docs/stories/1.3.core-card-creation-management-interface.md#performance-considerations]

### Data Models
- **Account Balance Model**: Balance tracking with cryptographic isolation using account context hashing [Source: architecture/data-models.md#user-model]
- **Funding Transaction Model**: Traditional payment method tracking with conversion details and status management [Source: architecture/data-models.md#cryptotransaction-model]
- **Payment Transaction Model**: Integration with existing payment processing for balance updates [Source: architecture/data-models.md#paymenttransaction-model]

### Database Schema
- **Funding Tables**: Create account_balances, funding_transactions, fund_allocations tables with row-level security [Source: architecture/database-schema.md]
- **Encryption**: All sensitive funding data encrypted with KMS keys and card context isolation [Source: architecture/database-schema.md#privacy-preserving-database-design]
- **Isolation**: Funding context hashing prevents cross-account data access [Source: architecture/database-schema.md#row-level-security]

### API Specifications
- **Funding Endpoints**: 
  - POST `/api/v1/funding/account` for account funding with traditional payment methods [Source: architecture/api-specification.md]
  - POST `/api/v1/funding/card/{cardId}` for allocating funds to specific cards [Source: architecture/api-specification.md]
  - POST `/api/v1/funding/transfer` for card-to-card balance transfers [Source: architecture/api-specification.md]
  - GET `/api/v1/funding/balance` for balance inquiries with real-time updates [Source: architecture/api-specification.md]
- **Authentication**: All endpoints require Bearer JWT authentication [Source: architecture/api-specification.md#components]
- **Rate Limiting**: Apply consistent rate limiting patterns from existing card endpoints [Source: architecture/api-specification.md]

### Component Specifications
- **Funding Service**: Node.js with Fastify framework, PostgreSQL integration, Stripe payment APIs [Source: architecture/components.md#card-lifecycle-service]
- **Balance Management**: Real-time balance tracking with Redis caching for performance [Source: architecture/components.md#cryptocurrency-integration-service]
- **Privacy Integration**: Funding operations must integrate with Privacy Protection Service for isolation [Source: architecture/components.md#privacy-protection-service]

### Stripe Integration Specifications
- **Payment Methods**: Support ACH bank transfers, debit cards, and credit cards via Stripe Elements
- **Webhook Security**: Validate webhook signatures using Stripe signing secret, implement idempotency for duplicate events
- **Error Handling**: Handle Stripe-specific error codes (card_declined, insufficient_funds, etc.) with user-friendly messages
- **Processing Times**: ACH transfers (3-5 business days), debit cards (instant), credit cards (instant) with appropriate user messaging
- **Fraud Protection**: Leverage Stripe Radar for machine learning-based fraud detection and custom rules for spending limits
- **Customer Management**: Create Stripe customers for payment method storage and recurring transactions

### File Locations
- **Backend Services**: `/apps/api/src/services/funding/` following established service patterns [Source: architecture/unified-project-structure.md#core-services]
- **Mobile Components**: `/apps/mobile/src/screens/funding/` and `/apps/mobile/src/components/funding/` [Source: architecture/unified-project-structure.md#mobile-app]
- **Web Components**: `/apps/web/src/app/dashboard/funding/` and `/apps/web/src/components/funding/` [Source: architecture/unified-project-structure.md#web-app]
- **Shared Types**: `/packages/shared/src/types/funding.ts` for cross-platform type safety [Source: architecture/unified-project-structure.md#shared-packages]

### Technical Constraints
- **Technology Stack**: Express.js backend, Supabase PostgreSQL, Redis caching, TypeScript throughout [Source: architecture/mvp-focused-tech-stack.md]
- **Payment Processing**: Stripe integration for traditional payment methods (bank transfers, debit cards) [Source: architecture/mvp-focused-tech-stack.md]
- **Stripe Configuration**: Use Stripe API v2023-10-16, Stripe Elements for secure payment collection, webhook endpoint security with signature validation
- **Stripe Environment**: Development uses test keys, production requires live keys with proper PCI compliance
- **Privacy Requirements**: All funding data must use row-level security and cryptographic isolation [Source: architecture/coding-standards.md#critical-fullstack-rules]
- **Type Safety**: Shared TypeScript interfaces required for all API contracts [Source: architecture/coding-standards.md#critical-fullstack-rules]

### Testing
- **Unit Tests**: Backend services in `/apps/api/tests/unit/services/funding.service.test.ts` [Source: architecture/testing-strategy.md#backend-tests]
- **Stripe Service Tests**: Mock Stripe API calls in `/apps/api/tests/unit/services/stripe.service.test.ts` using stripe-mock or nock
- **Integration Tests**: Funding API endpoints in `/apps/api/tests/integration/funding.integration.test.ts` [Source: architecture/testing-strategy.md#backend-tests]
- **Webhook Tests**: Stripe webhook handling tests with signature validation and event processing
- **Frontend Component Tests**: Mobile components in `/apps/mobile/__tests__/components/funding/` [Source: architecture/testing-strategy.md#frontend-tests]
- **E2E Tests**: Funding workflows in `/apps/mobile/__tests__/e2e/funding-flows.e2e.ts` using Stripe test payment methods [Source: architecture/testing-strategy.md#frontend-tests]
- **Test Patterns**: Follow established privacy isolation testing patterns from Story 1.3 [Source: architecture/testing-strategy.md#test-examples]

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2024-01-XX | 1.0 | Initial story creation | Scrum Master |
| 2025-08-05 | 1.1 | Added Stripe integration specifications and technical details | Product Owner |

## Dev Agent Record

*This section will be populated by the development agent during implementation.*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results

*This section will be populated by the QA agent after completion.*