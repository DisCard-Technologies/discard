# Story 4.3: Advanced Security Monitoring & Fraud Prevention

**Status:** Draft  
**Priority:** High  
**Epic:** Privacy & Security Features (Epic 4)  
**Dependencies:** Story 4.2 (Transaction Isolation & Privacy Protection)  
**Estimated Effort:** 20-24 hours  

## Story

**As a** user,  
**I want** sophisticated fraud protection that keeps my cards secure,  
**so that** I can use DisCard confidently while maintaining my privacy and security.

## Problem Statement

Users need advanced fraud protection that operates within the privacy constraints established in previous stories. The challenge is implementing sophisticated fraud detection and prevention mechanisms that analyze transaction patterns for individual cards without cross-card correlation or building comprehensive user profiles. The system must balance security effectiveness with privacy preservation, providing real-time protection while maintaining the transaction isolation principles that differentiate DisCard from traditional payment solutions.

## Solution Overview

Implement a privacy-preserving fraud detection system using card-specific behavioral analysis, machine learning models that operate on isolated data contexts, and automated response mechanisms that protect users without compromising their privacy. The system will leverage the isolation infrastructure from Story 4.2, implement real-time transaction analysis, and provide transparent security reporting while maintaining strict data separation between cards.

## Acceptance Criteria

1. Real-time fraud detection analyzes transaction patterns for each individual card without cross-card correlation or profiling
2. Behavioral analysis identifies unusual spending patterns, geographic anomalies, and merchant category changes for individual cards
3. Machine learning fraud models operate on card-specific data while maintaining privacy isolation and preventing comprehensive profiling
4. Automated card freezing temporarily disables cards showing suspicious activity with immediate user notification and manual review options
5. Security incident response system provides rapid reaction to potential fraud while maintaining user privacy and minimizing false positives
6. Multi-factor authentication options secure high-risk transactions and account changes without requiring invasive identity verification
7. Security reporting provides users with transparency about threats detected and actions taken while maintaining privacy protection

## Tasks/Subtasks

### Phase 1: Fraud Detection Infrastructure (8-10 hours)
1. **Card-Specific Fraud Detection Service** (4-5 hours) [AC: 1, 2]
   - [ ] Create `/apps/api/src/services/security/fraud-detection.service.ts` implementing real-time transaction analysis
   - [ ] Implement behavioral pattern analysis for individual cards using isolated contexts
   - [ ] Create anomaly detection algorithms for spending patterns, time-based, and geographic analysis
   - [ ] Integrate with transaction isolation service from Story 4.2 to maintain privacy boundaries
   - [ ] Add unit tests in `/apps/api/src/services/security/__tests__/fraud-detection.service.test.ts`

2. **Privacy-Preserving ML Models** (3-4 hours) [AC: 3]
   - [ ] Create `/apps/api/src/services/security/ml-fraud-model.service.ts` for card-specific fraud scoring
   - [ ] Implement feature extraction that operates only on single-card data contexts
   - [ ] Create model training pipeline that maintains isolation between card datasets
   - [ ] Add model versioning and performance tracking without cross-card data aggregation
   - [ ] Add unit tests for ML pipeline and privacy verification

3. **Fraud Event Storage** (1 hour) [AC: 1, 5]
   - [ ] Create database migration `/database/migrations/016_fraud_detection_schema.sql`
   - [ ] Design fraud_events table with card context isolation
   - [ ] Add indexes for real-time query performance
   - [ ] Implement RLS policies to prevent cross-card fraud data access

### Phase 2: Automated Response System (6-7 hours)
4. **Automated Card Freezing Service** (3-4 hours) [AC: 4]
   - [ ] Create `/apps/api/src/services/security/card-freeze.service.ts` for automated security responses
   - [ ] Implement rule-based freezing logic with configurable thresholds
   - [ ] Create manual override mechanisms for user control
   - [ ] Add automatic unfreezing workflows with time-based and manual options
   - [ ] Integrate with Marqeta API for real-time card status updates
   - [ ] Add comprehensive unit tests

5. **Security Incident Response** (2-3 hours) [AC: 5]
   - [ ] Create `/apps/api/src/services/security/incident-response.service.ts`
   - [ ] Implement incident classification and severity scoring
   - [ ] Create automated response workflows based on incident type
   - [ ] Add false positive tracking and model feedback mechanisms
   - [ ] Implement privacy-preserving incident logging

6. **Real-time Notification System** (1 hour) [AC: 4, 5]
   - [ ] Extend notification service for security alerts
   - [ ] Implement push notifications for fraud alerts and card freezing
   - [ ] Create in-app security alert display with action options
   - [ ] Add notification preferences for security events

### Phase 3: Authentication & User Controls (4-5 hours)
7. **Multi-Factor Authentication** (2-3 hours) [AC: 6]
   - [ ] Create `/apps/api/src/services/auth/mfa.service.ts` for enhanced authentication
   - [ ] Implement TOTP-based 2FA without phone number requirements
   - [ ] Create risk-based authentication triggers for high-value transactions
   - [ ] Add biometric authentication support for mobile app
   - [ ] Create MFA enrollment and recovery workflows

8. **Security API Controllers** (1-2 hours) [AC: 5, 7]
   - [ ] Create `/apps/api/src/controllers/security/fraud.controller.ts` for fraud management endpoints
   - [ ] Implement endpoints for fraud status checking and manual card control
   - [ ] Create security reporting endpoints with privacy filters
   - [ ] Add authentication and rate limiting middleware

9. **Mobile Security Components** (1 hour) [AC: 4, 7]
   - [ ] Create `/apps/mobile/src/components/security/FraudAlert.tsx` for security notifications
   - [ ] Create `/apps/mobile/src/components/security/CardFreezeControl.tsx` for manual control
   - [ ] Create `/apps/mobile/src/screens/security/SecurityDashboard.tsx` for security overview
   - [ ] Add component tests

### Phase 4: Testing & Documentation (2-3 hours)
10. **Comprehensive Testing** (1-2 hours) [AC: All]
    - [ ] Create integration tests in `/apps/api/src/__tests__/integration/fraud-detection.test.ts`
    - [ ] Add E2E tests in `/apps/mobile/e2e/security-workflows.e2e.js`
    - [ ] Create performance tests for real-time fraud detection
    - [ ] Add privacy verification tests

11. **Security Documentation** (1 hour) [AC: 7]
    - [ ] Document fraud detection algorithms and thresholds
    - [ ] Create user-facing security documentation
    - [ ] Add API documentation for security endpoints
    - [ ] Update privacy policy with security measures

## Dev Notes

### Technical Context from Previous Stories

#### Isolation Infrastructure from Story 4.2
Story 4.2 established comprehensive transaction isolation that this story must maintain:
```typescript
// Use existing isolation context for fraud detection
const isolationContext = await isolationService.getCardContext(cardId);
// All fraud analysis must operate within this context
```
[Source: Story 4.2 implementation]

#### Privacy Analytics Pattern from Story 4.2
Use the differential privacy patterns for any aggregated fraud metrics:
```typescript
// From privacy-analytics.service.ts
const privateMetrics = await privacyAnalyticsService.generatePrivateAnalytics({
  metricType: 'fraud_rate',
  privacyBudget: 0.5,
  k_anonymity_threshold: 10
});
```

### Architecture Context

#### Data Models for Fraud Detection
Based on existing card model, extend with fraud-specific fields:
```typescript
interface FraudEvent {
  eventId: string; // UUID v4
  cardContext: string; // Isolated card reference from Card model
  eventType: 'suspicious_transaction' | 'velocity_exceeded' | 'geographic_anomaly' | 'merchant_anomaly';
  riskScore: number; // 0-100
  detectedAt: Date;
  actionTaken: 'none' | 'alert' | 'freeze' | 'decline';
  falsePositive?: boolean; // For model feedback
}
```
[Source: architecture/data-models.md#card-model]

#### Database Schema Considerations
Extend existing RLS patterns for fraud data:
```sql
-- New fraud_events table must follow isolation pattern
CREATE TABLE fraud_events (
    event_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    card_context_hash TEXT NOT NULL, -- From cards table pattern
    event_type TEXT NOT NULL,
    risk_score INTEGER NOT NULL,
    event_data JSONB, -- Encrypted sensitive details
    action_taken TEXT NOT NULL,
    detected_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Apply same RLS pattern as payment_transactions
CREATE POLICY fraud_isolation ON fraud_events
    FOR ALL
    USING (card_context_hash = current_setting('app.card_context', true));
```
[Source: architecture/database-schema.md#row-level-security]

#### External API Integration - Marqeta
For real-time card control:
```typescript
// Card freeze/unfreeze through Marqeta
POST /cards/{card_token}/transitions
{
  "state": "SUSPENDED", // or "ACTIVE" to unfreeze
  "reason": "FRAUD_SUSPECTED",
  "channel": "API"
}
```
[Source: architecture/external-apis.md - Marqeta integration]

#### Security Performance Requirements
From security architecture:
- Fraud detection latency: <200ms for transaction analysis
- Card freeze execution: <1 second including Marqeta API call
- False positive rate target: <2% 
- Model update frequency: Daily with privacy-preserving aggregation
[Source: architecture/security-and-performance.md#performance-optimization]

#### File Structure for This Story
Based on unified project structure:

**Backend Services:**
- `/apps/api/src/services/security/fraud-detection.service.ts` - Real-time fraud analysis
- `/apps/api/src/services/security/ml-fraud-model.service.ts` - ML fraud scoring
- `/apps/api/src/services/security/card-freeze.service.ts` - Automated card control
- `/apps/api/src/services/security/incident-response.service.ts` - Security incident handling
- `/apps/api/src/services/auth/mfa.service.ts` - Multi-factor authentication

**API Controllers:**
- `/apps/api/src/controllers/security/fraud.controller.ts` - Fraud management endpoints

**Mobile Components:**
- `/apps/mobile/src/components/security/FraudAlert.tsx` - Alert display component
- `/apps/mobile/src/components/security/CardFreezeControl.tsx` - Manual freeze control
- `/apps/mobile/src/screens/security/SecurityDashboard.tsx` - Security overview screen

**Database:**
- `/database/migrations/016_fraud_detection_schema.sql` - Fraud detection tables

[Source: architecture/unified-project-structure.md]

### Technical Constraints

#### Privacy Constraints
- No cross-card correlation in fraud detection algorithms
- ML models must train on isolated card datasets only
- No user profiling or cross-card behavioral analysis
- Maintain transaction isolation from Story 4.2

#### Technology Stack
- Express.js for API endpoints (v4.18.2)
- TypeScript for type safety (v5.3.3)
- Supabase/PostgreSQL for data storage with RLS
- Redis for real-time fraud scoring cache
- Jest + Supertest for testing
[Source: architecture/mvp-focused-tech-stack.md]

#### Testing Requirements
- Unit tests: 80% coverage minimum using Jest
- Integration tests: Test fraud detection with isolated contexts
- E2E tests: Mobile workflows using Detox
- Performance tests: Verify <200ms fraud detection
[Source: architecture/testing-strategy.md]

## Testing

### Testing Standards
- Test files location: `__tests__/` directories adjacent to source files
- Use Jest for unit tests with 80% coverage requirement
- Use Supertest for API integration tests
- Use Detox for mobile E2E tests
- Mock external services (Marqeta) in tests
- Verify privacy isolation in all test scenarios

### Key Test Scenarios
1. Fraud detection operates only within card context
2. ML models don't access cross-card data
3. Card freezing completes within 1 second
4. False positive feedback improves model accuracy
5. MFA triggers appropriately for high-risk transactions
6. Security reports maintain privacy boundaries

## Definition of Done

- [ ] All acceptance criteria implemented and tested
- [ ] Real-time fraud detection operational with <200ms latency
- [ ] ML fraud models trained and deployed with privacy verification
- [ ] Automated card freezing integrated with Marqeta
- [ ] Multi-factor authentication implemented without phone numbers
- [ ] Security dashboard provides transparent reporting
- [ ] All tests passing with required coverage
- [ ] Performance benchmarks met
- [ ] Privacy isolation verified through testing
- [ ] Documentation complete
- [ ] Code review completed
- [ ] Deployed to staging environment

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-10 | 1.0 | Initial story creation for Epic 4.3 based on PRD requirements and architecture analysis | Bob (Scrum Master) |